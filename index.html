<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø± Ù¾ÙˆÙ„ - Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ù„ÛŒ Ø´Ø®ØµÛŒ</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="DaarPool">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/shaemi/DaarPool/refs/heads/main/DaarPool.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS Ø´Ù…Ø§ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", "Arial", sans-serif; background-color: #f2f2f7; color: #000; display: flex; justify-content: center; align-items: flex-start; padding: 20px; min-height: 100vh; }
        main { width: 100%; max-width: 800px; }
        h1 { text-align: right; font-size: 34px; font-weight: 700; color: #000; margin-bottom: 20px; }
        h2 { text-align: right; font-size: 22px; font-weight: 600; color: #000; margin-bottom: 15px; padding-right: 5px; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background-color: #ffffff; border-radius: 10px; padding: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 15px; color: #555; padding-right: 5px; }
        .input-group input[type="text"], #goal textarea { width: calc(100% - 30px); padding: 12px 15px; border: 1px solid #c8c8cc; border-radius: 8px; font-size: 16px; background-color: #fcfcfc; }
        button { width: 100%; padding: 14px; border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; font-size: 17px; transition: opacity 0.2s; }
        button:hover { opacity: 0.85; }
        #btn-add-income { background-color: #34C759; }
        #btn-add-expense { background-color: #FF3B30; }
        #report { padding-top: 10px; padding-bottom: 10px; }
        #report p { display: flex; justify-content: space-between; border-bottom: 1px solid #e5e5ea; padding: 14px 5px; margin: 0; font-size: 17px; }
        #report p:last-child { border-bottom: none; }
        #report p span:first-child { font-weight: 500; color: #333; }
        #balance { font-weight: 600; font-size: 18px; }
        #goal textarea { min-height: 80px; resize: vertical; }
        .backup-section { display: flex; gap: 10px; margin-top: 15px; }
        .btn-secondary { background-color: #007AFF; }
        .btn-tertiary { background-color: #8E8E93; }
        .btn-danger { background-color: #FF3B30; }
        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { grid-template-columns: 1fr; gap: 15px; }
            h1 { font-size: 30px; margin-bottom: 15px; }
            h2 { font-size: 20px; }
            .backup-section { flex-direction: column; }
        }
    </style>
</head>
<body>

    <main>
        <h1>ğŸ’° Ø¯Ø§Ø± Ù¾ÙˆÙ„</h1>
        
        <div class="container">
            <section class="card" id="inputs">
                <h2>Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´</h2>
                <div class="input-group">
                    <label for="income-amount">Ù…Ø¨Ù„Øº Ø¯Ø±Ø¢Ù…Ø¯ (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="text" id="income-amount" placeholder="Ù…Ø«Ù„Ø§: ÛµÛ°Û°Û°Û°Û°">
                </div>
                <button id="btn-add-income">Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø¢Ù…Ø¯ +</button>
                <hr style="border: none; border-top: 1px solid #e5e5ea; margin: 20px 0;">
                <div class="input-group">
                    <label for="expense-label">Ø´Ø±Ø­ Ù‡Ø²ÛŒÙ†Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <input type="text" id="expense-label" placeholder="Ù…Ø«Ù„Ø§: Ù†Ø§Ù‡Ø§Ø±">
                </div>
                <div class="input-group">
                    <label for="expense-amount">Ù…Ø¨Ù„Øº Ù‡Ø²ÛŒÙ†Ù‡ (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="text" id="expense-amount" placeholder="Ù…Ø«Ù„Ø§: Û±ÛµÛ°Û°Û°Û°">
                </div>
                <button id="btn-add-expense">Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø²ÛŒÙ†Ù‡ -</button>
            </section>

            <section class="card" id="report">
                <h2>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ</h2>
                <p><span>Ø¯Ø±Ø¢Ù…Ø¯:</span> <span id="report-income">0 ØªÙˆÙ…Ø§Ù†</span></p>
                <p><span>Ù‡Ø²ÛŒÙ†Ù‡:</span> <span id="report-expense">0 ØªÙˆÙ…Ø§Ù†</span></p>
                <p id="balance"><span>ØªØ±Ø§Ø² (Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡):</span> <span id="report-balance">0 ØªÙˆÙ…Ø§Ù†</span></p>

                <div class="backup-section">
                    <button id="btn-backup" class="btn-secondary">Ø¯Ø±ÛŒØ§ÙØª Ø¨Ú©Ø§Ù¾</button>
                    <button id="btn-restore" class="btn-tertiary">Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ú©Ø§Ù¾</button>
                </div>
                
                <div style="margin-top: 10px;">
                    <button id="btn-reset" class="btn-danger">Ø±ÛŒØ³Øª Ú©Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
                </div>

                <input type="file" id="restore-file-input" accept=".json, .txt" style="display: none;">
            </section>

            <section class="card" id="goal">
                <h2>ğŸ¯ Ø¨ÙˆØ¯Ø¬Ù‡ Ùˆ Ù‡Ø¯Ù Ù…Ø§Ù„ÛŒ</h2>
                <label for="financial-goal">Ù‡Ø¯Ù ÛŒØ§ Ø¨ÙˆØ¯Ø¬Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯:</label>
                <textarea id="financial-goal" placeholder="Ù…Ø«Ù„Ø§: Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Û³ Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø³ÙØ±..."></textarea>
            </section>

            <section class="card" id="chart-container">
                <h2>Ù†Ù…ÙˆØ¯Ø§Ø± Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</h2>
                <canvas id="expense-chart"></canvas>
            </section>
        </div>
    </main>

    <script>
        // --- Ù…ØªØºÛŒØ± Ø­Ø§ÙˆÛŒ Ø¯ÛŒØªØ§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ---
        const defaultAppData = {
            totalIncome: 0,
            totalExpense: 0,
            expenseLabels: [],
            expenseData: []
        };

        // --------- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ (Ø¯ÛŒØªØ§ Ø§Ø³ØªÙˆØ±) ---------
        let appData = { ...defaultAppData };

        // --------- Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¹Ù†Ø§ØµØ± ---------
        const incomeAmountInput = document.getElementById('income-amount');
        const expenseAmountInput = document.getElementById('expense-amount');
        const expenseLabelInput = document.getElementById('expense-label');
        const btnAddIncome = document.getElementById('btn-add-income');
        const btnAddExpense = document.getElementById('btn-add-expense');
        const reportIncomeEl = document.getElementById('report-income');
        const reportExpenseEl = document.getElementById('report-expense');
        const reportBalanceEl = document.getElementById('report-balance');
        const btnBackup = document.getElementById('btn-backup');
        const btnRestore = document.getElementById('btn-restore');
        const restoreFileInput = document.getElementById('restore-file-input');
        const btnReset = document.getElementById('btn-reset');
        const API_URL = 'api.php';

        // --------- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---------
        function convertToEN(str) {
            if (!str) return '';
            str = String(str);
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø­Ø°Ù Ú©Ø§Ù…Ø§ØŒ Ú†ÙˆÙ† Ú©Ø§Ø±Ø¨Ø± Ù…Ù…Ú©Ù† Ø§Ø³Øª "1,000" ØªØ§ÛŒÙ¾ Ú©Ù†Ø¯
            str = str.replace(/,/g, ''); 
            
            const persianDigits = /[\u06F0-\u06F9]/g;
            const arabicDigits = /[\u0660-\u0669]/g;
            return str.replace(persianDigits, d => d.charCodeAt(0) - 0x06F0)
                      .replace(arabicDigits, d => d.charCodeAt(0) - 0x0660);
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('fa-IR').format(num) + ' ØªÙˆÙ…Ø§Ù†';
        }

        // --------- ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¢Ù¾Ø¯ÛŒØª UI ---------
        
        function updateReport() {
            const balance = appData.totalIncome - appData.totalExpense;
            reportIncomeEl.textContent = formatCurrency(appData.totalIncome);
            reportExpenseEl.textContent = formatCurrency(appData.totalExpense);
            reportBalanceEl.textContent = formatCurrency(balance);
            if (balance < 0) reportBalanceEl.style.color = '#FF3B30';
            else if (balance > 0) reportBalanceEl.style.color = '#34C759';
            else reportBalanceEl.style.color = '#000';
        }

        const ctx = document.getElementById('expense-chart').getContext('2d');
        const expenseChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: appData.expenseLabels,
                datasets: [{
                    label: 'Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§',
                    data: appData.expenseData,
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'top' } } }
        });

        function updateChart() {
            expenseChart.data.labels = appData.expenseLabels;
            expenseChart.data.datasets[0].data = appData.expenseData;
            expenseChart.update();
        }

        function applyDataToApp(data) {
            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ø¯ÛŒØªØ§ÛŒ Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø³ØªÛŒ Ø¯Ø§Ø±Ø¯
            appData = { ...defaultAppData, ...data };
            updateReport();
            updateChart();
        }

        // --------- ØªÙˆØ§Ø¨Ø¹ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± (Ù‡Ø§Ø³Øª) ---------

        async function saveDataToServer() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appData)
                });
                const result = await response.json();
                if(result.status !== 'success') {
                    console.error('Error saving data:', result.message);
                }
            } catch (error) {
                console.error('Failed to save data:', error);
            }
        }

        async function loadDataFromServer() {
            try {
                const response = await fetch(API_URL, { method: 'GET' });
                const data = await response.json();
                if(data && typeof data.totalIncome === 'number') {
                    applyDataToApp(data);
                } else {
                    applyDataToApp({ ...defaultAppData }); 
                }
            } catch (error) {
                console.error('Failed to load data:', error);
                applyDataToApp({ ...defaultAppData });
            }
        }

        // --------- ØªÙˆØ§Ø¨Ø¹ Ø¨Ú©Ø§Ù¾ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ---------

        function backupData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            const date = new Date().toISOString().split('T')[0];
            link.download = `daarpool-backup-${date}.json`; // *** ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ø¨Ú©Ø§Ù¾ ***
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = e.target.result;
                    const restoredData = JSON.parse(json);
                    if (restoredData && typeof restoredData.totalIncome === 'number') {
                        applyDataToApp(restoredData);
                        saveDataToServer(); 
                        alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯.');
                    } else {
                        alert('ÙØ§ÛŒÙ„ Ø¨Ú©Ø§Ù¾ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.');
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        }

        // --------- ØªØ§Ø¨Ø¹ Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ---------
        
        function resetAllData() {
            const isConfirmed = confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ\nØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø±Ø¢Ù…Ø¯ØŒ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯!");
            if (isConfirmed) {
                appData = { ...defaultAppData };
                applyDataToApp(appData);
                saveDataToServer();
                alert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±ÛŒØ³Øª Ø´Ø¯.");
            }
        }

        // --------- Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ (Event Listeners) ---------
        
        btnAddIncome.addEventListener('click', () => {
            // *** Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² convertToEN Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ø¨Ù„Øº ***
            const amount = parseFloat(convertToEN(incomeAmountInput.value)) || 0;
            if (amount > 0) {
                appData.totalIncome += amount;
                updateReport();
                incomeAmountInput.value = '';
                saveDataToServer();
            }
        });

        btnAddExpense.addEventListener('click', () => {
            // *** Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² convertToEN Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ø¨Ù„Øº ***
            const amount = parseFloat(convertToEN(expenseAmountInput.value)) || 0;
            const label = expenseLabelInput.value || 'Ù‡Ø²ÛŒÙ†Ù‡ Ù…ØªÙØ±Ù‚Ù‡';
            if (amount > 0) {
                appData.totalExpense += amount;
                appData.expenseLabels.push(label);
                appData.expenseData.push(amount);
                updateReport();
                updateChart();
                expenseAmountInput.value = '';
                expenseLabelInput.value = '';
                saveDataToServer();
            }
        });

        btnBackup.addEventListener('click', backupData);
        btnRestore.addEventListener('click', () => restoreFileInput.click());
        restoreFileInput.addEventListener('change', restoreData);
        btnReset.addEventListener('click', resetAllData);

        // --------- Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---------
        loadDataFromServer();

    </script>
</body>

</html>
